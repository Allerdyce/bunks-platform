# PriceLabs Read-Only Pricing Integration (Bunks Architecture)

## Purpose
This document defines the **approved architecture and implementation steps** for integrating PriceLabs as a **read-only pricing engine** for Bunks, while allowing bookings to occur via **Airbnb or Bunks**, and keeping **availability in sync** across platforms.

This approach avoids any requirement for Airbnb pricing write access or PMS ownership changes.

---

## High-Level Architecture

### Authoritative Roles
- **PriceLabs** → Pricing engine (AI-driven nightly rates)
- **Airbnb** → Authoritative pricing executor for Airbnb bookings
- **Bunks** → Booking surface + availability coordinator
- **iCal** → Availability synchronization mechanism

### Data Flow
```
PriceLabs
 ├─ pushes pricing → Airbnb (direct integration)
 └─ exposes pricing → Bunks (read-only via Customer API)

Bunks
 ├─ displays PriceLabs-derived pricing (estimates)
 ├─ validates availability via iCal
 └─ confirms price at checkout
```

**Key constraint**  
Bunks does NOT push pricing to Airbnb and does NOT act as the pricing authority.

---

## Two Separate PriceLabs Integrations (Do Not Confuse)

### 1. PMS Integration API (Already Implemented)
- Used for: certification, webhook connectivity
- Auth: `X-Integration-Token`
- Direction: PriceLabs → PMS (push)
- NOT used for reading prices

### 2. Customer API (This Document)
- Used for: **pulling recommended prices**
- Auth: API Key generated by host in PriceLabs UI
- Direction: Bunks → PriceLabs (pull)
- **Read-only pricing access**

This document ONLY concerns **Customer API usage**.

---

## Host Prerequisite (One-Time Setup)

Each host must:
1. Log into PriceLabs
2. Go to **Account Settings → API Details / API Access**
3. Generate an **API Key**
4. Provide that key to Bunks

### Security Requirements
- One API key per host
- Store encrypted
- Host can revoke or rotate at any time
- Never hardcode

---

## Authentication

### Environment Variable
```
PRICELABS_API_KEY=<host-provided key>
```

### HTTP Authentication
(Confirm exact header via Swagger)
```http
Authorization: Bearer PRICELABS_API_KEY
Content-Type: application/json
```
or
```http
X-API-KEY: PRICELABS_API_KEY
```

---

## Pricing Pull (Core Feature)

### Goal
Retrieve **recommended nightly prices** from PriceLabs for display and estimation in Bunks.

### Conceptual Endpoint
```
POST /prices
```

### Example Request
```json
{
  "listing_ids": ["bunks_<property_id>"],
  "start_date": "2025-10-01",
  "end_date": "2026-03-31"
}
```

### Example Response
```json
{
  "prices": {
    "2025-10-01": 189,
    "2025-10-02": 195,
    "2025-10-03": 210
  }
}
```

> NOTE: Exact endpoint path and response shape must match PriceLabs Swagger.

---

## Listing Mapping Requirements

- The listing must already exist in the host’s PriceLabs account
- The API key must belong to the same account
- The `listing_id` used by Bunks must match the ID known to PriceLabs

Bunks must enforce listing ownership internally.

---

## Data Storage Model (Recommended)

Store PriceLabs pricing as **advisory**:

```text
price_source: pricelabs
listing_id: bunks_<property_id>
date: YYYY-MM-DD
nightly_price: number
retrieved_at: timestamp
ttl_expires_at: timestamp
confidence: estimated
```

---

## Refresh Strategy

### Recommended Cadence
- Nightly pull for next 365–730 days
- Optional on-demand refresh:
  - when host changes pricing rules
  - when calendar is opened

### Do NOT
- Pull pricing on every page load
- Treat pricing as authoritative
- Cache indefinitely

---

## Pricing Display Rules (Bunks UI)

### Browsing
- Show:
  - “From $X / night”
  - “Prices vary by date”
- Optional label:
  - “Powered by PriceLabs”

### Calendar
- Show nightly estimates
- Tooltip:
  > “Nightly prices are estimates based on current market conditions.”

### Checkout
- Revalidate availability
- Confirm price freshness (TTL)
- Require user confirmation if updated

> Final copy must clearly state that price is confirmed before payment.

---

## Checkout Validation Logic

At checkout, Bunks MUST:
1. Recheck availability (via iCal)
2. Ensure pricing data is within TTL
3. Prompt confirmation if pricing changed

Bunks does NOT:
- Recalculate PriceLabs logic
- Push prices to Airbnb
- Guarantee parity

---

## Failure & Fallback Handling

### If API Key Is Missing or Revoked
- Hide detailed pricing
- Fall back to:
  - “From $X”
  - or “Request quote”

### If Pricing Is Stale
- Refresh before checkout
- Or require confirmation

---

## Explicit Non-Goals

- Bunks does NOT become Airbnb PMS
- Bunks does NOT push prices to Airbnb
- Bunks does NOT guarantee live pricing parity

---

## Strategic Outcome

This architecture:
- Keeps PriceLabs as pricing engine
- Protects Airbnb revenue integrity
- Enables Bunks bookings safely
- Scales toward future channel-manager or partner upgrades

---

## One-Sentence Summary

**PriceLabs prices Airbnb directly; Bunks pulls PriceLabs pricing read-only for display and estimation, validates availability via iCal, and confirms pricing at checkout without acting as the pricing authority.**
